import React, { createContext, useContext, useEffect, useState, useCallback } from 'react';\nimport { getSqliteDB } from '../services/SqliteDB';\n\nexport interface CartItem {\n  id: string;\n  product_id: string;\n  quantity: number;\n  data_json: string;\n  created_at: string;\n}\n\nexport interface CartContextType {\n  items: CartItem[];\n  itemCount: number;\n  totalPrice: number;\n  addItem: (productId: string, quantity: number, productData: any) => Promise<void>;\n  updateQuantity: (cartItemId: string, quantity: number) => Promise<void>;\n  removeItem: (cartItemId: string) => Promise<void>;\n  clearCart: () => Promise<void>;\n  isLoading: boolean;\n  error: string | null;\n}\n\nconst CartContext = createContext<CartContextType | undefined>(undefined);\n\nexport function CartProvider({ children }: { children: React.ReactNode }) {\n  const [items, setItems] = useState<CartItem[]>([]);\n  const [isLoading, setIsLoading] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n\n  // Load cart from SqliteDB on mount\n  useEffect(() => {\n    loadCart();\n  }, []);\n\n  const loadCart = async () => {\n    try {\n      setIsLoading(true);\n      const db = getSqliteDB();\n      const cartItems = await db.getCartItems();\n      setItems(cartItems);\n      setError(null);\n    } catch (err) {\n      console.error('[CartContext] Error loading cart:', err);\n      setError('Failed to load cart');\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const addItem = useCallback(async (productId: string, quantity: number, productData: any) => {\n    try {\n      setIsLoading(true);\n      const db = getSqliteDB();\n      const cartItemId = `cart_${productId}_${Date.now()}`;\n\n      await db.addCartItem({\n        id: cartItemId,\n        product_id: productId,\n        quantity,\n        data_json: JSON.stringify(productData),\n      });\n\n      // Reload cart\n      await loadCart();\n      setError(null);\n    } catch (err) {\n      console.error('[CartContext] Error adding item:', err);\n      setError('Failed to add item to cart');\n    } finally {\n      setIsLoading(false);\n    }\n  }, []);\n\n  const updateQuantity = useCallback(async (cartItemId: string, quantity: number) => {\n    try {\n      setIsLoading(true);\n      const db = getSqliteDB();\n\n      if (quantity <= 0) {\n        await db.removeCartItem(cartItemId);\n      } else {\n        await db.updateCartItemQuantity(cartItemId, quantity);\n      }\n\n      // Reload cart\n      await loadCart();\n      setError(null);\n    } catch (err) {\n      console.error('[CartContext] Error updating quantity:', err);\n      setError('Failed to update quantity');\n    } finally {\n      setIsLoading(false);\n    }\n  }, []);\n\n  const removeItem = useCallback(async (cartItemId: string) => {\n    try {\n      setIsLoading(true);\n      const db = getSqliteDB();\n      await db.removeCartItem(cartItemId);\n\n      // Reload cart\n      await loadCart();\n      setError(null);\n    } catch (err) {\n      console.error('[CartContext] Error removing item:', err);\n      setError('Failed to remove item');\n    } finally {\n      setIsLoading(false);\n    }\n  }, []);\n\n  const clearCart = useCallback(async () => {\n    try {\n      setIsLoading(true);\n      const db = getSqliteDB();\n      await db.clearCart();\n      setItems([]);\n      setError(null);\n    } catch (err) {\n      console.error('[CartContext] Error clearing cart:', err);\n      setError('Failed to clear cart');\n    } finally {\n      setIsLoading(false);\n    }\n  }, []);\n\n  // Calculate totals\n  const itemCount = items.reduce((sum, item) => sum + item.quantity, 0);\n  const totalPrice = items.reduce((sum, item) => {\n    try {\n      const product = JSON.parse(item.data_json);\n      const precio = typeof product.precio === 'string' ? parseFloat(product.precio) : product.precio;\n      return sum + (precio * item.quantity);\n    } catch {\n      return sum;\n    }\n  }, 0);\n\n  const value: CartContextType = {\n    items,\n    itemCount,\n    totalPrice,\n    addItem,\n    updateQuantity,\n    removeItem,\n    clearCart,\n    isLoading,\n    error,\n  };\n\n  return <CartContext.Provider value={value}>{children}</CartContext.Provider>;\n}\n\nexport function useCart() {\n  const context = useContext(CartContext);\n  if (!context) {\n    throw new Error('useCart must be used within CartProvider');\n  }\n  return context;\n}\n